!function(){window.socket=io.connect("/");var t=t||{};t.App={init:function(){this.attachImageClicked(),this.contextMenu(),this.attachSocketEvents(),this.initToolbar()},attachSocketEvents:function(){var t=$("#imgContent"),e=$("#addImage-tpl").html(),a=$("#addVideo-tpl").html();socket.on("addImage",function(n){if(n.localtime=new Date(n.ctime).toString(),"video"==n.type){var i=Handlebars.compile(a);result=i(n)}else{var i=Handlebars.compile(e);result=i(n)}var o=t.find("a[data-ctime]");if(o.length>0){var r=!1;o.each(function(t,e){var a=$(e);return!(a.data("ctime")<n.ctime)||(a.before(result),r=!0,!1)}),r||t.append(result)}else t.append(result)}),socket.on("updateImage",function(n){var i=n.url;if("video"==n.type){var o=Handlebars.compile(a);result=o(n)}else{var o=Handlebars.compile(e);result=o(n)}t.children().each(function(t,e){var a=$(this).find("img").eq(0),n=a.attr("src").split("?")[0];if(n==i){var o=i+"?"+(new Date).getTime();a.attr("src",o)}})}),socket.on("removeImage",function(n){var i=n.url;if("video"==n.type){var o=Handlebars.compile(a);result=o(n)}else{var o=Handlebars.compile(e);result=o(n)}t.children().each(function(t,e){var a=$(this).find("img").eq(0),n=a.attr("src").split("?")[0];n==i&&$(this).remove()})}),socket.on("initFilter",function(t){var e=$("#select-from"),a=$("#select-to");for(var n in t)e.append($("<option></option>").attr("value",t[n]).text(t[n])),a.append($("<option></option>").attr("value",t[n]).text(t[n]));e.attr("data-min",t[0]),e.attr("data-max",t[t.length-1]),a.attr("data-min",t[0]),a.attr("data-max",t[t.length-1]),e.change(function(){a.find("option").show();var t=this.value;a.find("option").each(function(e,a){t>=$(a).val()&&$(a).hide()})})})},contextMenu:function(){var t,e=$("#contextMenu");$("body").on("contextmenu","a",function(a){return t=$(a.target).parent(),e.css({display:"block",left:a.pageX,top:a.pageY}),!1}),e.on("click","a",function(){t&&t.parent().hide("slow")}),$(document).on("click",function(){e.hide(),t=null})},attachImageClicked:function(t){var e={};e.fb_user_connect=!1,e.fb_user_name="",$("#imgContent").on("click","a",function(t){if(t.preventDefault(),$('input[name="share-confirm"]').prop("checked")?$(".share-btn").prop("disabled",!1):$(".share-btn").prop("disabled",!0),$("#header-bar .btn-start-select").hasClass("toggle"))return $(this).toggleClass("selected"),!1;"video"==$(this).attr("data-cmedia-type")?(e.media_type="video",e.url=$(this).children("video").children("source").attr("src"),e.caption=$(this).children("video").children("source").attr("alt"),e.username=$(this).children("video").children("source").attr("data-photo-username"),e.created_time=$(this).children("video").children("source").attr("data-created-time"),e.obj=$(this)):(e.media_type="image",e.url=$(this).children("img").attr("src"),e.caption=$(this).children("img").attr("alt"),e.username=$(this).children("img").attr("data-photo-username"),e.created_time=$(this).children("img").attr("data-created-time"),e.obj=$(this));var a=readCookie("systemId");if(""==a||null==a){var n=guidGenerator();a=createCookie("systemId",n,10)}if(0==e.fb_user_connect){var i=$.ajax({url:"https://instantly.sg/fb_api.php",type:"POST",data:{sid:a,action:"fb_check_connection"}});i.done(function(t){var a=JSON.parse(t);""!=a.data&&""!=a.data.fb_name&&(e.fb_user_connect=!0,e.fb_user_name=a.data.fb_name)}),i.fail(function(t,e){alert("Request failed: "+e)})}new Dialog(e,socket)})},renderTemplate:function(t){var e,a,n,i,o=$(document).width(),r=t,c=$("#mostRecent-tpl").html(),s=Handlebars.compile(c),l=s(r),d=$("#imgContent"),m=$("<img/>").attr("src",t.url);m.load(function(){setTimeout(function(){d.prepend(l),d.find("a:first-child").append(m),noofphoto=$("#imgContent div.photoslide").size(),i=$("#imgContent div:first-child"),a=$("#imgContent div:first-child").find("img").attr("src"),n=$("#imgContent div:nth-child(2)").find("img").attr("src"),a===n&&i.remove(),i=$("#imgContent").find("div:first-child").removeClass("Hvh"),o>=900&&(e=$("#imgContent").find("div:nth-child(2)").addClass("animated rotateInDownLeft"),$("#imgContent").find("div.photoslide").removeClass("animated rotateInDownLeft"))},500)})},initToolbar:function(){$("#header-bar .btn-filter").on("click",function(){var t=$("#imgContent"),e=t.find("a[data-ctime]"),a=$("#select-to").val(),n=$("#select-from").val();if(!(n>=a)){e.removeClass("filtered");var i=n.split(":"),o=a.split(":"),r=60*parseInt(i[0])+parseInt(i[1]),c=60*parseInt(o[0])+parseInt(o[1]);e.each(function(t,e){var a=$(e),n=a.data("ctime"),i=new Date(n),o=i.getHours(),s=i.getMinutes();(r>60*o+s||60*o+s>=c)&&a.addClass("filtered")})}}),$("#header-bar .btn-reset").on("click",function(){$("#select-to").val("0"),$("#select-from").val("0");var t=$("#imgContent");t.find("a").removeClass("filtered");var e=t.find("a");e.removeClass("selected"),$("#select-to").find("option").show()}),$("#header-bar .btn-start-select").on("click",function(){if($(this).toggleClass("toggle"),$("#footer-bar").toggleClass("toggle"),!$(this).hasClass("toggle")){var t=$("#imgContent");t.find("a").removeClass("selected")}}),$("#footer-bar .select-done-btn").on("click",function(){var t=$("#imgContent"),e=t.find("a.selected"),a=[];e.each(function(t,e){a.push($(e).children("img").attr("src"))});var n={};n.url=a;new Dialog(n,socket);$("#header-bar .btn-start-select").removeClass("toggle"),e.removeClass("selected"),$("#footer-bar").removeClass("toggle")}),$(document).ready(function(){keyboard_interface(),$(window).on("load",function(){delete_cookie("copy_data")})})}},t.App.init()}(this);
function keyboard_interface(){$.keyboard.keyaction.copy=function(e,t,a,o){$(".ui-keyboard-input-current").focus(),clipData=$(".ui-keyboard-input-current").val(),clipData=createCookie("copy_data",clipData);try{document.execCommand("copy")}catch(i){}},$.keyboard.keyaction.paste=function(e){clipData=readCookie("copy_data"),null!=clipData&&""!=clipData&&e.insertText(clipData)};var e="";$(".field-keyboard-tool").keyboard({layout:"qwerty",usePreview:!1,restrictInput:!1,preventPaste:!0,layout:"custom",customLayout:{normal:["` 1 2 3 4 5 6 7 8 9 0 - = {bksp}","{tab} q w e r t y u i o p [ ] \\","a s d f g h j k l ; ' {enter}","{shift} z x c v b n m @ , . / {shift}","@ gmail hotmail yahoo .com .sg .com.sg","{copy} {paste} {space} {accept}  {cancel}"],shift:["~ ! @ # $ % ^ & * ( ) _ + {bksp}","{tab} Q W E R T Y U I O P { } |",'A S D F G H J K L : " {enter}',"{shift} Z X C V B N M < > ? {shift}","@ gmail hotmail yahoo .com .sg .com.sg","{copy} {paste} {space} {accept}  {cancel}"]}}).on("beforeVisible",function(){e="";var t=$(this).offset().top,a=$(this).offset().left,o=$(this).height(),i=8;$(this).hasClass("add-extra-height-offset")&&(i=17);var n=parseInt(t)+parseInt(o)+i;parseInt(a)-30;$(".ui-keyboard").css("top",n),$(".ui-keyboard").css("left",-120)}),$(".field-keyboard-tool").bind("keyboardChange",function(t,a,o){"enter"!=a.last.key&&13!=a.last.event.keyCode||a.accept(),e=a.$preview.val()}),$(".field-keyboard-tool").bind("canceled",function(t,a,o){$(this).val(e)})}function createCookie(e,t,a){var o="";if(a){var i=new Date;i.setTime(i.getTime()+24*a*60*60*1e3),o="; expires="+i.toUTCString()}document.cookie=e+"="+t+o+"; path=/"}function readCookie(e){for(var t=e+"=",a=document.cookie.split(";"),o=0;o<a.length;o++){for(var i=a[o];" "==i.charAt(0);)i=i.substring(1,i.length);if(0==i.indexOf(t))return i.substring(t.length,i.length)}return null}function delete_cookie(e){document.cookie=e+"=;expires=Thu, 01 Jan 1970 00:00:01 GMT;"}function guidGenerator(){var e=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}Behavior=function(e){this._dialog=e},Behavior.prototype.attachEvent=function(){},Behavior.prototype.detachEvent=function(){},NullBehavior=function(e){Behavior.call(this,e)},NullBehavior.contructor=NullBehavior,NullBehavior.prototype=new Behavior,FirstBehavior=function(e){Behavior.call(this,e)},FirstBehavior.contructor=FirstBehavior,FirstBehavior.prototype=new Behavior,FirstBehavior.prototype.attachEvent=function(){var e=this;$(document).on("click",".yes-btn",function(t){var a=$("form.form-data"),o=[],i=[];a.find(":input").each(function(e,t){var a=$(t).attr("name");return!(!$(t).is("button")&&!$(t).is("input[type=button]"))||void(i.indexOf(a)==-1&&i.push(a))}),a.find(".message").remove();var n={required:"This field is required",email:"Please input valid email address",phone:"Please input valid phone number",number:"Please input numbers",min:"Minimum charactors for this field is invalid",max:"Maximum charactors for this field is invalid",atleast:"Select at least minimum required checkboxes",atmost:"Select at most maximum required checkboxes"};return i.forEach(function(e){var t,i=a.find("[name="+e+"]"),l=i.val(),r="";if(i.is("[type=checkbox]")||i.is("[type=radio]")){var c=i.parent(),d=[];a.find("[name="+e+"]:checked").each(function(e,t){d.push($(t).val())}),c.data("required")&&0===d.length&&(r="required"),0===r.length&&c.data("at-least")&&d.length<c.data("at-least")&&(r="atleast"),0===r.length&&c.data("at-most")&&d.length>c.data("at-most")&&(r="atmost"),r.length>0&&0===c.find(".message").length&&c.append('<div class="message">'+n[r]+"</div>"),l=d.join(",")}else{if(i.data("required")&&0===l.length&&(r="required"),0===r.length&&i.data("valid-email"))if(t=/^[-a-z0-9~!$%^&*_=+}{\'?]+(\.[-a-z0-9~!$%^&*_=+}{\'?]+)*@([a-z0-9_][-a-z0-9_]*(\.[-a-z0-9_]+)*\.(aero|arpa|biz|com|coop|edu|gov|info|int|mil|museum|name|net|org|pro|travel|mobi|[a-z][a-z])|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(:[0-9]{1,5})?$/i,l.indexOf(",")>-1){for(var s=l.split(","),u='<br/> "',m=s.length-1;m>=0;m--)emailItem=$.trim(s[m]),""==emailItem||t.test(emailItem)||(u+=emailItem+",",r="email");"email"==r&&(u=u.replace(/,$/,""),n.email+=u+'"')}else t.test(l)||(r="email");0===r.length&&i.data("valid-phone")&&(t=/^(8|9)\d{7}$/,t.test(l)||(r="phone")),0===r.length&&i.data("valid-number")&&(t=/^(\d+)$/,t.test(l)||(r="number")),(i.data("valid-min")||i.data("valid-max"))&&0===r.length&&(l.length<i.data("valid-min")?r="min":l.length>i.data("valid-max")&&(r="max")),r.length>0&&i.after('<div class="message">'+n[r]+"</div>")}o.push({name:e,value:l})}),a.find(".message").length>0?(t.preventDefault(),void t.stopPropagation()):($.ajax({url:"/saveform",type:"POST",data:o}).done(function(e){}),e.detachEvent(),void e._dialog.next(new ChoosePhotoStyle(e._dialog)))}),$(document).on("click",".btn-next",function(t){e.detachEvent(),e._dialog.next(new ChoosePhotoStyle(e._dialog))}),keyboard_interface()},FirstBehavior.prototype.detachEvent=function(){$(document).off("click",".yes-btn"),$(document).off("click",".btn-next")},ChoosePhotoStyle=function(e){Behavior.call(this,e)},ChoosePhotoStyle.contructor=ChoosePhotoStyle,ChoosePhotoStyle.prototype=new Behavior,ChoosePhotoStyle.prototype.attachEvent=function(){var e=this,t="https://instantly.sg/fb_api.php",a=readCookie("systemId");if(""==a||null==a){var o=guidGenerator();a=createCookie("systemId",o,10)}$(document).off("click",'input[name="share-confirm"]'),$(document).off("click",".share-btn"),$(document).off("click",".fb-login-btn"),$(document).off("click",".fb-log-out-btn"),$(document).off("click",".fb-next-btn"),$(document).off("click",".email-btn"),$(document).off("click",".fb-post-btn"),$(document).on("click",'input[name="share-confirm"]',function(){$(this).prop("checked")?$(".share-btn").prop("disabled",!1):$(".share-btn").prop("disabled",!0)}),$(document).on("click",".share-btn",function(t){t.preventDefault(),"video"==e._dialog._context.media_type&&$("#active-video1")[0].pause(),1==e._dialog._context.fb_user_connect?($("#fb-user-name").html(e._dialog._context.fb_user_name),e._dialog.NextBehaviorStep(new Printout(e._dialog),5)):e._dialog.NextBehaviorStep(new Printout(e._dialog),4)}),$(document).on("click",".fb-login-btn",function(){var o=window.open(t+"?action=fb_connect&id="+a,"fb-connect","height=400,width=500"),i=setInterval(function(){if(o.closed){var a=readCookie("systemId");if(clearInterval(i),""==a||null==a){var n=guidGenerator();a=createCookie("systemId",n,10)}var l=$.ajax({url:t,type:"POST",data:{sid:a,action:"fb_check_connection"}});l.done(function(t){var a=JSON.parse(t);""!=a.data&&""!=a.data.fb_name&&(e._dialog._context.fb_user_connect=!0,e._dialog._context.fb_user_name=a.data.fb_name,e._dialog.NextBehaviorStep(new Printout(e._dialog),6))}),l.fail(function(e,t){alert("Request failed: "+t)})}},500)}),$(document).on("click",".fb-log-out-btn",function(){var o=$(this),i=$.ajax({url:t,type:"POST",data:{sid:a,action:"remove_fb_user"}});i.done(function(t){e._dialog._context.fb_user_connect=!1,e._dialog._context.fb_user_name="";var a=JSON.parse(t),i="https://www.facebook.com/logout.php?access_token="+a.data.access_token;i+="&next="+a.data.redirect_url;var n=window.open(i,"height=400,width=500"),l=setInterval(function(){if(n.closed){readCookie("systemId");clearInterval(l)}},500);o.hasClass("logout-full")?$("#myModal").modal("hide"):e._dialog.NextBehaviorStep(new Printout(e._dialog),4),$(document).off("click",".fb-log-out-btn")}),$(document).off("click",".fb-log-out-btn"),i.fail(function(e,t){alert("Request failed: "+t)})}),$(document).on("click",".fb-next-btn",function(){"video"==e._dialog._context.media_type&&$("#active-video2")[0].play(),e._dialog.NextBehaviorStep(new Printout(e._dialog),6)}),$(document).on("click",".fb-post-btn",function(){var t="fb_share_photo";$(".fb-post-btn").prop("disabled",!0),"video"==e._dialog._context.media_type&&(t="fb_share_video"),$(".loader").show();var o=$(".media-caption").val()+" -by Ewan Sou",i=$.ajax({url:"uploadMedia",type:"POST",data:{sid:a,action:t,caption:o,filePath:$(".commentImg").attr("src")}});i.done(function(t){$(".fb-post-btn").prop("disabled",!1),$(document).off("click",".fb-post-btn"),e._dialog.NextBehaviorStep(new Printout(e._dialog),7),$(".loader").hide()}),i.fail(function(e,t){$(".fb-post-btn").prop("disabled",!1),alert("Request failed: "+t),$(".loader").hide()})}),$(document).on("click",".print-btn",function(){e._dialog.nextWithoutBehavior()}),$(document).on("click",".mms-btn",function(){e.detachEvent(),e._dialog.nextMMSBehavior(new Printout(e._dialog))}),$(document).on("click",".email-btn",function(){var t=[],a=$("select.print-amount").val()||1;$(":checkbox.image-type").each(function(){this.checked&&t.push($(this).val())}),t.length&&(e.detachEvent(),e._dialog.setImgType(t.join(",")),e._dialog.setPrintAmount(a),$("form.form-data").length>0?e._dialog.NextBehaviorStep(new Printout(e._dialog),3):e._dialog.NextBehaviorStep(new Printout(e._dialog),2)),keyboard_interface()}),$(document).on("click",".next-image-style",function(){var t=[],a=$("select.print-amount").val()||1;$(":checkbox.image-type").each(function(){this.checked&&t.push($(this).val())}),t.length?(e.detachEvent(),e._dialog.setImgType(t.join(",")),e._dialog.setPrintAmount(a),e._dialog.print(),$("#myModal").modal("hide")):$(".err-msg").removeClass("hide")})},ChoosePhotoStyle.prototype.detachEvent=function(){$(document).off("click",".next-image-style"),$(document).off("click",".email-btn"),$(document).off("click",".share-btn"),$(document).off("click",".fb-login-btn"),$(document).off("click",".fb-log-out-btn"),$(document).off("click",".fb-next-btn"),$(document).off(".fb-post-btn"),$(document).off("click",".print-btn"),$(document).off("click",".mms-btn"),$(".err-msg").addClass("hide")},Printout=function(e){Behavior.call(this,e)},Printout.contructor=Printout,Printout.prototype=new Behavior,Printout.prototype.attachEvent=function(){var e=this;$(".submit-email").click(function(t){t.preventDefault(),$(".email-error").html("Please enter a valid email address");var a=$("#emailInput").val(),o=$("#nameInput").val(),i=$("#addressInput").val(),n=!0,l="";if(a.indexOf(",")>-1){for(var r=a.split(","),c=r.length-1;c>=0;c--)emailItem=$.trim(r[c]),""==emailItem||e._isValidEmail(emailItem)||(n=!1,l+=emailItem+",");""!=l&&(l=l.replace(/,$/,""),$(".email-error").append(' <br/>"'+l+'"'))}else n=e._isValidEmail(a);return n?(e.detachEvent(),$(".email-error").html("Please enter a valid email address."),e._dialog.sendLogMail(a,o,i),e._dialog.next(new NullBehavior(e._dialog)),$("#myModal").modal("hide")):($("#emailInput").focus().parent().addClass("has-error"),$(".err-msg").removeClass("hide")),!1}),$(".submit-mms").click(function(t){var a=$("#phoneInput").val();e._isValidPhone(a)?(e.detachEvent(),e._dialog.next(new NullBehavior(e._dialog)),e._dialog.sendMMS(a),$("#myModal").modal("hide")):($("#phoneInput").focus().parent().addClass("has-error"),$(".err-msg").removeClass("hide"))}),this._t=setInterval(function(){var e=$("#emailInput").val(),t=$("#phoneInput").val();e&&(e.length?$(".submit-email").removeClass("disabled"):$(".submit-email").addClass("disabled")),t&&(t.length?$(".submit-mms").removeClass("disabled"):$(".submit-mms").addClass("disabled"))},500)},Printout.prototype.detachEvent=function(){$(".submit-email").off("click"),$(".submit-mms").off("click"),clearInterval(this._t)},Printout.prototype._isValidEmail=function(e){var t=/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;return t.test(e)},Printout.prototype._isValidPhone=function(e){var t=/^[9|8][0-9]{7}$/;return t.test(e)};var clipData="";
Dialog=function(t,o){var e=t.url.split(".").pop();if("gif"==e||"GIF"==e?t.print_btn='disabled="disabled"':t.print_btn="",t.is_autoplay="autoplay",this._context=t,this._socket=o,"video"==t.media_type){var i=$("#dialog-video-tpl").html();i.indexOf("form-data")!==-1&&(t.is_autoplay="");var n=Handlebars.compile(i),a=n(t);$(document.body).append(a)}else{var i=$("#dialog-tpl").html(),n=Handlebars.compile(i),a=n(t);$(document.body).append(a)}$("form.form-data").length>0?this.setBehavior(new FirstBehavior(this)):this.setBehavior(new ChoosePhotoStyle(this)),this._modal=$("#myModal").modal(),this._carousel=$("#carousel-example-generic").carousel({interval:!1}),"video"==t.media_type&&i.indexOf("form-data")!==-1&&($(".yes-btn, .btn-next").click(function(){$("#active-video1")[0].play()}),$(".fb-next-btn").click(function(){$("#active-video2")[0].play()})),Array.isArray(t.url)?(this._behavior.detachEvent(),$("form.form-data").length>0?this.NextBehaviorStep(new Printout(this),3):this.NextBehaviorStep(new Printout(this),2)):($("#commentImg").attr("src",t.url),$(".commentImg").attr("src",t.url)),this.attachEvent()},Dialog.prototype.attachEvent=function(){var t=this;this._modal.on("hidden.bs.modal",function(o){t._behavior.detachEvent(),$("#myModal").remove(),t=null})},Dialog.prototype.sendMail=function(){var t=this;this._context.imgtypes=this._imgType,this._context.amount=this._printAmount,$.ajax({url:"/sendMail",type:"POST",data:this._context}).done(function(o){t.filename=o.filename})},Dialog.prototype.print=function(){this._context.imgtypes=this._imgType,this._context.amount=this._printAmount,socket.emit("print",this._context);var t=this._context.obj.find("span.numberprinted");t.attr("data-np",parseInt(t.attr("data-np"))+parseInt(this._printAmount)),t.text(t.attr("data-np"))},Dialog.prototype.sendMMS=function(t){this._context.phoneNumer=t,$.ajax({url:"/sendmms",type:"POST",data:this._context}).done(function(t){})},Dialog.prototype.sendLogMail=function(t,o,e){this._context.imgtypes=this._imgType,this._context.amount=this._printAmount,this._context.name=o,this._context.mail=t,this._context.address=e,$.ajax({url:"/sendMail",type:"POST",data:{mail:t,url:this._context.url}}).done(function(t){})},Dialog.prototype._printPhoto=function(){popup=window.open(),popup.document.write('<img src="'+this._context.url+'" />'),popup.print()},Dialog.prototype.setImgType=function(t){this._imgType=t},Dialog.prototype.setPrintAmount=function(t){this._printAmount=t},Dialog.prototype.setBehavior=function(t){this._behavior=t,this._behavior.attachEvent()},Dialog.prototype.next=function(t){this._carousel.carousel("next"),this.setBehavior(t)},Dialog.prototype.nextWithoutBehavior=function(){this._carousel.carousel("next")},Dialog.prototype.NextBehaviorStep=function(t,o){this._carousel.carousel(o),this.setBehavior(t)},Dialog.prototype.nextMMSBehavior=function(t){this._carousel.carousel(3),this.setBehavior(t)};